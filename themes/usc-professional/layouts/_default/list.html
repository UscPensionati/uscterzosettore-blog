{{ define "main" }}
<div class="list-page-container">

  {{/* CONTROLLO: Se siamo nella pagina principale delle categorie (/categories/), mostra tutte le categorie */}}
  {{ if and (eq .Type "categories") (eq .Kind "taxonomy") }}

    <header class="list-header">
      <div class="list-breadcrumbs">
        <a href="{{ "/" | relURL }}">Home</a>
        <span class="breadcrumb-separator">→</span>
        <span>Tutte le Categorie</span>
      </div>
      <h1 class="list-title">Tutte le Categorie</h1>
      <p class="list-description">Esplora tutti i nostri contenuti organizzati per argomento.</p>
    </header>

    <section class="categories-grid-enhanced">
      {{/* Iteriamo sulla lista "master" definita in hugo.toml */}}
      {{ range .Site.Params.all_categories.list }}
        {{ $categoryName := .name }}
        {{ $categorySlug := $categoryName | urlize }}
        {{ $categoryURL := printf "/categories/%s/" $categorySlug | relURL }}
        
        {{/* Contiamo dinamicamente i post per questa categoria - versione robusta */}}
        {{ $categoryPosts := where $.Site.RegularPages "Params.categories" "intersect" (slice $categoryName) }}
        {{ if eq (len $categoryPosts) 0 }}
          {{/* Fallback: prova anche con category singolare */}}
          {{ $categoryPosts = where $.Site.RegularPages "Params.category" $categoryName }}
        {{ end }}
        {{ $categoryCount := len $categoryPosts }}

        <div class="category-card-enhanced">
          <a href="{{ $categoryURL }}" class="category-card-link">
            <div class="category-image-enhanced">
              <img src="{{ .image | relURL }}" alt="{{ $categoryName }}" loading="lazy">
              
              <div class="category-count-badge {{ if eq $categoryCount 0 }}zero{{ end }}">
                {{ $categoryCount }} {{ if eq $categoryCount 1 }}articolo{{ else }}articoli{{ end }}
              </div>
              
              <div class="category-icon">
                {{ if eq $categoryName "Agricoltura Sociale" }}
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M7 20h10"/>
                    <path d="M10 20c5.5-2.5.8-6.4 3-10"/>
                    <path d="M9.5 9.4c1.1.8 1.8 2.2 2.3 3.7-2 .4-3.5.4-4.8-.3-1.2-.6-2.3-1.9-3-4.2 2.8-.5 4.4 0 5.5.8z"/>
                    <path d="M14.1 6a7 7 0 0 0-1.1 4c1.9-.1 3.3-.7 4.3-1.4 1-1.5 1.2-2.7 1.1-4.2-2.4.1-3.8 1.2-4.3 1.6z"/>
                  </svg>
                {{ else if eq $categoryName "Tutela Legale" }}
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 11V7a4 4 0 0 0-8 0v4"/>
                    <rect x="3" y="11" width="18" height="10" rx="2" ry="2"/>
                    <circle cx="12" cy="16" r="1"/>
                  </svg>
                {{ else if eq $categoryName "Assistenza Sanitaria" }}
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                  </svg>
                {{ else if eq $categoryName "Patronato" }}
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="8.5" cy="7" r="4"/>
                    <path d="M20 8v6"/>
                    <path d="M23 11h-6"/>
                  </svg>
                {{ else if eq $categoryName "Giovani Idee" }}
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"/>
                    <line x1="12" y1="1" x2="12" y2="3"/>
                    <line x1="12" y1="21" x2="12" y2="23"/>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                    <line x1="1" y1="12" x2="3" y2="12"/>
                    <line x1="21" y1="12" x2="23" y2="12"/>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                  </svg>
                {{ else if eq $categoryName "Donazioni" }}
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20,12 20,22 4,22 4,12"/>
                    <rect x="2" y="7" width="20" height="5"/>
                    <line x1="12" y1="22" x2="12" y2="7"/>
                    <path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/>
                    <path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/>
                  </svg>
                {{ else if eq $categoryName "News" }}
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14,2 14,8 20,8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                    <polyline points="10,9 9,9 8,9"/>
                  </svg>
                {{ end }}
              </div>
            </div>
            
            <div class="category-card-content-enhanced">
              <div class="category-card-header">
                <div>
                  <h3 class="category-card-title">{{ $categoryName }}</h3>
                  <p class="category-card-description">{{ .description }}</p>
                </div>
                <div class="category-card-arrow">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18l6-6-6-6"/>
                  </svg>
                </div>
              </div>
              
              {{ if gt $categoryCount 0 }}
                <div class="category-card-posts">
                  <h4 class="category-posts-title">Articoli recenti</h4>
                  {{ range first 3 $categoryPosts }}
                    <div class="category-card-post">
                      <span class="post-title-preview">{{ .Title }}</span>
                      <span class="post-date-preview">{{ .Date.Format "2 Jan 2006" }}</span>
                    </div>
                  {{ end }}
                </div>
              {{ else }}
                <div class="empty-category">
                  Presto saranno pubblicati nuovi contenuti.
                </div>
              {{ end }}
            </div>
          </a>
        </div>
      {{ end }}
    </section>

  {{ else }}

    <!-- VISTA LISTA ARTICOLI (per /posts/ o /categories/nome-categoria/) -->
    <header class="list-header">
      <div class="list-breadcrumbs">
        <a href="{{ "/" | relURL }}">Home</a>
        {{ if eq .Type "categories" }}
          <span class="breadcrumb-separator">→</span>
          <a href="{{ "/categories/" | relURL }}">Categorie</a>
          <span class="breadcrumb-separator">→</span>
          <span>{{ .Title }}</span>
        {{ else if eq .Type "posts" }}
          <span class="breadcrumb-separator">→</span>
          <span>Tutti gli Articoli</span>
        {{ end }}
      </div>
      <h1 class="list-title">
        {{ if eq .Type "categories" }}{{ end }}{{ .Title }}
      </h1>
      <p class="list-description">
        {{ if .Description }}
          {{ .Description }}
        {{ else if eq .Type "categories" }}
          Tutti gli articoli nella categoria <strong>{{ .Title }}</strong>.
        {{ else if eq .Type "posts" }}
          Tutti gli articoli pubblicati sul blog di USC Ente del Terzo Settore.
        {{ end }}
      </p>
    </header>

    {{ if .Paginator.Pages }}
      <section class="posts-list">
        {{ range .Paginator.Pages }}
          <article class="post-list-item">
            <div class="post-list-content">
              <div class="post-list-meta">
                {{ with .Params.categories }}
                  <span class="post-list-category">{{ index . 0 }}</span>
                {{ else with .Params.category }}
                  <span class="post-list-category">{{ . }}</span>
                {{ end }}
                <span class="post-list-date">{{ .Date.Format "2 Jan 2006" }}</span>
              </div>
              <h2 class="post-list-title">
                <a href="{{ .Permalink }}">{{ .Title }}</a>
              </h2>
              <p class="post-list-excerpt">{{ .Summary | truncate 150 }}</p>
            </div>
            {{ if .Params.cover.image }}
              <div class="post-list-image">
                <a href="{{ .Permalink }}">
                  <img src="{{ .Params.cover.image | relURL }}" alt="{{ .Params.cover.alt | default .Title }}" loading="lazy">
                </a>
              </div>
            {{ end }}
          </article>
        {{ end }}
      </section>
      
      {{ template "_internal/pagination.html" . }}
      
    {{ else }}
      <div class="no-posts-message">
        <h2>Nessun articolo trovato</h2>
        <p>Non ci sono ancora articoli in questa categoria.</p>
        <a href="{{ "/categories/" | relURL }}" class="back-home-link">← Torna a tutte le categorie</a>
      </div>
    {{ end }}
    
  {{ end }}

</div>
{{ end }}